<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsmästaren Duell (Online)</title>
    <!-- Laddar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ANVÄNDER ÄLDRE, STABILARE FIREBASE (v7.1.0) -->
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-firestore.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .btn-base {
            padding: 0.75rem 1rem;
            font-size: 1rem; 
            font-weight: 700;
            transition: all 0.2s;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-start { background-color: #10b981; color: white; }
        .btn-p1 { background-color: #ef4444; color: white; box-shadow: 0 8px 10px rgba(239, 68, 68, 0.4); }
        .btn-p2 { background-color: #3b82f6; color: white; box-shadow: 0 8px 10px rgba(59, 130, 246, 0.4); }
        .btn-base:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }
        .btn-base:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        .input-code {
            padding: 0.75rem;
            border: 2px solid #ccc;
            border-radius: 0.5rem;
            text-transform: uppercase;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-start min-h-screen p-4">

    <div id="app-container" class="w-full max-w-lg bg-white p-4 md:p-6 rounded-xl shadow-2xl text-center mx-auto mt-4 mb-4">
        
        <!-- Autentiseringsstatus -->
        <p id="auth-status" class="text-xs text-gray-500 mb-4 break-all">Initierar...</p>

        <!-- Initial Huvudrubrik -->
        <h1 id="app-title" class="text-2xl font-extrabold text-gray-900 mb-2">Tidsmästaren: Duell (Online)</h1>
        <p id="app-description" class="text-sm text-gray-600 mb-4">Tävla mot en vän över internet. Bäst av 3 rundor!</p>

        <!-- --- SPELKONTROLL (SETUP) --- -->
        <div id="game-control-area" class="space-y-4 p-4 rounded-xl bg-gray-50 border hidden">
            <h2 class="text-xl font-bold text-gray-800">Skapa eller Gå Med</h2>
            
            <button id="start-button" class="btn-base btn-start w-full" disabled>
                Starta Nytt Spel (Spelare 1)
            </button>

            <!-- BORTTAGET: Fält för manuell kodinmatning -->
            
            <!-- NY SEKTION FÖR TILLGÄNGLIGA SPEL -->
            <div id="available-games-area" class="text-left">
                <h3 class="text-sm font-bold text-gray-700 mb-2">Aktiva spel att gå med i:</h3>
                <div id="available-games-list" class="space-y-2">
                    <!-- Spelknappar renderas här -->
                    <p class="text-xs text-gray-400">Hämtar...</p>
                </div>
            </div>
            <!-- SLUT NY SEKTION -->
        </div>

        <!-- --- HUVUD SPELYTA (GAME) --- -->
        <div id="main-game-area" class="hidden">
            
            <p id="game-code-display" class="text-sm font-semibold text-indigo-700 mb-2">Ingen match aktiv</p>
            
            <!-- Omgångsräknare & Måltid Display -->
            <div class="mb-4 p-4 bg-indigo-50 rounded-lg shadow-inner">
                <p id="round-counter" class="text-sm font-semibold text-indigo-700 mb-1">Omgång -- av 3</p>
                <h2 id="target-display" class="text-base font-semibold text-indigo-700">Väntar på uppkoppling...</h2>
                <p id="target-time" class="text-3xl font-mono text-indigo-900 mt-1">--</p>
            </div>

            <p id="waiting-for-player" class="text-lg font-bold text-red-600 mb-4 hidden">Väntar på motståndare...</p>

            <!-- Poängtavla -->
            <div id="scoreboard-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 border-gray-300 bg-gray-50">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Total Felmarginal (Lägst är Bäst)</h3>
                <!-- Resultat visas här i stället för hårkodade P1/P2 -->
                <div id="total-scoreboard" class="flex flex-col gap-2 text-sm text-gray-700">
                    <p class="text-center text-xs text-gray-500">Resultat visas när matchen är slut.</p>
                </div>
            </div>

            <!-- Resultat Display (Per Omgång) -->
            <div id="result-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 hidden">
                <h3 class="text-xl font-bold mb-3 text-gray-800">Resultat Omgång</h3>

                <div id="round-results-display" class="flex flex-wrap gap-3 justify-center">
                    <!-- Spelresultat renderas här -->
                </div>

                <p id="round-winner-status" class="text-lg font-extrabold mt-3 p-2 rounded-lg bg-yellow-100 text-yellow-800"></p>
            </div>

            <!-- Slutresultat -->
            <div id="final-result-area" class="p-4 rounded-xl shadow-2xl hidden bg-purple-100 border-4 border-purple-500">
                <h3 class="text-2xl font-extrabold text-purple-800 mb-2">TOTAL VINNARE! 🎉</h3>
                <p id="final-winner-status" class="text-xl font-bold text-gray-800 mb-2"></p>
            </div>

            <!-- Interaktionsknappar -->
            <div class="space-y-3 mt-4">
                <div class="flex gap-3">
                    <!-- FIX: Visa en universell knapp för den egna spelaren -->
                    <button id="multi-wait-button" class="btn-base btn-p2 w-full" disabled> Tryck NU! </button>
                </div>
                <!-- FIX: Nytt ID för att separera från SETUP-knappen i den första kontrollen -->
                <button id="start-next-round-button" class="btn-base btn-start w-full"> STARTA OMGÅNG </button>
            </div>
            
            <button onclick="resetLocalState()" class="text-xs text-gray-500 mt-4 underline">Lämna match/Återställ</button>
        </div>

    </div>

    <script>
        
        // --- GLOBALA VARIABLER (KORRIGERAD FÖR ONLINE HOSTING) ---
        const appId = 'GITHUB_DUEL_ID';
        
        // ***********************************************************************************
        // !!! VIKTIGT: KLISTRA IN DIN PERSONLIGA firebaseConfig HÄR !!!
        // ***********************************************************************************
        const firebaseConfig = {
    apiKey: "AIzaSyAmsrwDhNmVZsmYmnGEmA9c7nznBTj1G7M",
    authDomain: "tidsduellen.firebaseapp.com",
    projectId: "tidsduellen",
    storageBucket: "tidsduellen.firebasestorage.app",
    messagingSenderId: "397732128249",
    appId: "1:397732128249:web:f27ddc610c300b4b504928",
    measurementId: "G-THJVN8S9EN"
    };
            const initialAuthToken = null; 
            
            // Simulerar ett unikt ID för att komma runt API-nyckelkravet.
            // Använder localStorage för att spara ett konstant ID per användare/webbläsare
            const storedUserId = localStorage.getItem('multiUserId');
            const simulatedUserId = storedUserId || crypto.randomUUID();
            if (!storedUserId) localStorage.setItem('multiUserId', simulatedUserId);


            let app, db, auth;
            let userId = simulatedUserId; // Använd det sparade/genererade ID:t
            let gameId = null;
            let playerRole = null; // Ej strikt nödvändigt med flera spelare, men behålls för vissa UI-kontroller
            let playerIndex = -1; // Det här är viktigt: Spelarens index i playerIds-arrayen

            // Globala elementreferenser
            const authStatus = document.getElementById('auth-status');
            const gameControlArea = document.getElementById('game-control-area');
            const startSetupButton = document.getElementById('start-button'); // Knappen i SETUP-läget
            const startNextRoundButton = document.getElementById('start-next-round-button'); // Knappen i GAME-läget
            const joinGameCode = document.getElementById('join-game-code'); // BORTTAGEN i HTML, men behålls för att undvika JS-fel
            const joinButton = document.getElementById('join-button'); // BORTTAGEN i HTML, men behålls för att undvika JS-fel
            const gameCodeDisplay = document.getElementById('game-code-display');
            const waitingForPlayer = document.getElementById('waiting-for-player');
            const roundCounter = document.getElementById('round-counter');
            const targetDisplay = document.getElementById('target-display');
            const targetTimeText = document.getElementById('target-time');
            const multiWaitButton = document.getElementById('multi-wait-button'); // Universell klickknapp
            const resultArea = document.getElementById('result-area');
            const roundWinnerStatus = document.getElementById('round-winner-status');
            const totalScoreboard = document.getElementById('total-scoreboard'); // Nytt: För total poängtavla
            const roundResultsDisplay = document.getElementById('round-results-display'); // Nytt: För resultat per omgång
            const availableGamesList = document.getElementById('available-games-list'); // Referens för listan

            // Per-omgång resultat element (behövs inte längre, renderas dynamiskt)
            
            // Spelets konstanter
            const MS_TO_S = 1000;
            const maxRounds = 3; 

            // --- FIREBASE INITIALISERING OCH SIMULERAD AUTENTISERING ---

            function getGameRef(id = gameId) {
                if (!db || !db.collection) {
                    throw new Error("Firestore instance (db) is not initialized.");
                }
                // Sparar i rotnivån 'games/{gameId}'
                return db.collection('games').doc(id); 
            }
            
            function getGamesCollection() {
                if (!db || !db.collection) {
                    throw new Error("Firestore instance (db) is not initialized.");
                }
                // Hämta alla spel i rotnivån
                return db.collection('games');
            }

            // KORRIGERAD: Genererar en 3-siffrig kod (000-999)
            function generateGameCode() {
                return String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            }

            async function initFirebase() {
                try {
                    if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                        throw new Error("Firebase library not defined globally. Check network access to CDN or if script loading failed.");
                    }

                    // ANVÄNDER V7 SYNTAX FÖR INITIALISERING
                    // FIX: Initierar appen korrekt med den klistrade konfigurationen
                    app = firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebase.firestore.setLogLevel('debug'); 

                    // --- SIMULERAD INLOGGNING ---
                    authStatus.textContent = `Ditt Användar-ID: ${userId.substring(0, 8)}...`;
                    
                    // FIX: Anropa resetLocalState direkt efter initiering för att tvinga UI-visning
                    resetLocalState();
                    
                    // --- SLUT SIMULERAD INLOGGNING ---

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    // Extra instruktion om att byta konfiguration om det misslyckas.
                    authStatus.textContent = `KRITISKT FEL: Anslutningsfel. Har du klistrat in din PERSONLIGA firebaseConfig? (${error.message || 'Okänt fel'})`;
                }
            }
            
            function initApp() {
                // Kontrollera att Firebase har laddats innan vi initierar
                if (typeof firebase !== 'undefined' && firebase.initializeApp) {
                    initFirebase();
                } else {
                    document.getElementById('auth-status').textContent = 'KRITISKT FEL: Firebase-biblioteken kunde inte laddas. Kontrollera nätverksåtkomst till CDN:er.';
                    console.error("Firebase library not defined after aggressive check.");
                }
            }

            // --- NY: FUNKTION FÖR ATT LYSSNA PÅ TILLGÄNGLIGA SPEL ---

            let unsubscribeAvailableGames = null;

            function listenForAvailableGames() {
                if (unsubscribeAvailableGames) unsubscribeAvailableGames();

                // Hämtar spel som är i SETUP och där vår ID inte finns (så att vi kan gå med)
                const gamesRef = getGamesCollection().where('status', '==', 'SETUP');
                
                unsubscribeAvailableGames = gamesRef.onSnapshot((snapshot) => {
                    renderAvailableGames(snapshot.docs);
                }, (error) => {
                    console.error("Error fetching available games:", error);
                });
            }

            function renderAvailableGames(gameDocs) {
                let html = '';
                let gamesFound = 0;

                gameDocs.forEach(doc => {
                    const data = doc.data();
                    
                    // Filtrera bort spel du redan är med i
                    if (data.playerIds && data.playerIds.includes(userId)) return;

                    const playerCount = data.playerIds ? data.playerIds.length : 0;

                    html += `
                        <button onclick="joinExistingGame('${data.gameCode}')" 
                            class="btn-base btn-p2 w-full text-sm py-2 px-3 justify-between flex items-center bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-400">
                            <span>Spelkod: <strong>${data.gameCode}</strong></span>
                            <span>Spelare: ${playerCount} anslutna</span>
                        </button>
                    `;
                    gamesFound++;
                });

                if (gamesFound === 0) {
                    html = '<p class="text-xs text-gray-400">Inga aktiva spel hittades. Starta ett nytt!</p>';
                }
                
                availableGamesList.innerHTML = html;
            }


            // --- SPELHANTERING OCH DATABASFUNKTIONER ---

            /** Genererar en slumpmässig tid mellan 5.00 och 30.00 sekunder (i millisekunder). */
            function generateRandomTime() {
                const minMs = 5000;
                const maxMs = 30000;
                return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
            }

            /** Formaterar en avvikelse. */
            function formatDeviation(deviationMs, element) {
                const deviationSecondsAbsolute = Math.abs(deviationMs / MS_TO_S).toFixed(2);
                const deviationSign = deviationMs >= 0 ? '+' : '-';
                
                // Rensa gamla färger
                element.classList.remove('text-red-600', 'text-yellow-600', 'text-green-600'); 

                if (Math.abs(deviationMs) < 100) { // < 0.10s är perfekt
                    element.classList.add('text-green-600');
                } else if (deviationMs < 0) {
                    // För tidigt
                    element.classList.add('text-yellow-600'); 
                } else {
                    // För sent
                    element.classList.add('text-red-600'); 
                }

                return `${deviationSign}${deviationSecondsAbsolute} s`;
            }

            /** Uppdaterar UI baserat på spelarroll och spelstatus. */
            function updateUI(gameData) {
                // Dölj SETUP-vyn och visa GAME-vyn
                gameControlArea.classList.add('hidden');
                mainGameArea.classList.remove('hidden');
                
                // Hantera synlighet av rubriker
                if (gameData.round > 1 || gameData.status === 'MATCH_FINISHED') {
                    document.getElementById('app-title').classList.add('hidden');
                    document.getElementById('app-description').classList.add('hidden');
                } else {
                    document.getElementById('app-title').classList.remove('hidden');
                    document.getElementById('app-description').classList.remove('hidden');
                }

                // Omgångsräknare
                roundCounter.textContent = `Omgång ${gameData.round} av ${maxRounds}`;
                gameCodeDisplay.textContent = `Spelkod: ${gameData.gameCode}`;


                // --- Hantera Spelstatus ---
                
                // Resultat och slutstatus
                resultArea.classList.add('hidden');
                finalResultArea.classList.add('hidden');
                
                // Standardläge för knappar
                multiWaitButton.disabled = true;
                startNextRoundButton.disabled = true; 

                if (gameData.status === 'SETUP') {
                    targetDisplay.textContent = 'Väntar på motståndare...';
                    targetTimeText.textContent = `Koden: ${gameData.gameCode}`;
                    waitingForPlayer.classList.remove('hidden');

                    if (gameData.playerIds[0] === userId) {
                        // FIX: Tillåt ensamspel direkt
                        startNextRoundButton.textContent = `STARTA OMGÅNG 1 av ${maxRounds}`;
                        startNextRoundButton.disabled = false; 
                    } else {
                         startNextRoundButton.textContent = `Väntar på skaparen att starta...`;
                         startNextRoundButton.disabled = true;
                    }
                    
                    // Uppdatera spelarlista i setup
                    totalScoreboard.innerHTML = `<p class="font-bold">Anslutna spelare: ${gameData.playerIds.length}</p>`;
                    totalScoreboard.classList.remove('hidden');
                    
                } else if (gameData.status === 'WAITING_FOR_CLICKS') {
                    waitingForPlayer.classList.add('hidden');
                    targetDisplay.textContent = 'Stäng ögonen och räkna! 🧠';
                    targetTimeText.textContent = `${(gameData.targetTimeMs / MS_TO_S).toFixed(2)} s`; 

                    const clickIndex = gameData.playerIds.indexOf(userId);
                    
                    multiWaitButton.style.display = 'block'; 
                    
                    if (clickIndex !== -1) {
                        if (gameData.clickTimes[clickIndex] === 0) {
                            multiWaitButton.disabled = false;
                            multiWaitButton.textContent = 'Tryck NU!';
                        } else {
                            multiWaitButton.textContent = 'Klickat!';
                        }
                    } else {
                        // Om spelaren tittar på matchen men inte är med
                        multiWaitButton.style.display = 'none';
                    }

                } else if (gameData.status === 'ROUND_FINISHED') {
                    waitingForPlayer.classList.add('hidden');
                    targetDisplay.textContent = 'Rundan avslutad!';
                    targetTimeText.textContent = 'Se Resultatet!';

                    // Visa resultatdetaljer
                    displayResultDetails(gameData);
                    displayScoreboard(gameData);

                    // Hantera nästa runda. Endast skaparen (PlayerIds[0]) startar.
                    if (gameData.playerIds[0] === userId) {
                        const nextRound = gameData.round + 1;
                        startNextRoundButton.disabled = false; // AKTIVERA KNAPPEN

                        if (nextRound > maxRounds) {
                            startNextRoundButton.textContent = 'SPELA IGEN (Reset)';
                        } else {
                            // FIX: Tydlig text för nästa omgång
                            startNextRoundButton.textContent = `STARTA NÄSTA OMGÅNG (${nextRound} av ${maxRounds})`; 
                        }
                    } else {
                        startNextRoundButton.textContent = `Väntar på skaparen att starta nästa omgång...`;
                        startNextRoundButton.disabled = true;
                    }

                } else if (gameData.status === 'MATCH_FINISHED') {
                    waitingForPlayer.classList.add('hidden');
                    targetDisplay.textContent = `Matchen är Slut!`;
                    targetTimeText.textContent = 'Spela Igen!';

                    // Visa slutresultatet
                    displayFinalWinner(gameData);
                    displayScoreboard(gameData); // Visa final scoreboard

                    // Endast skaparen startar om
                    if (gameData.playerIds[0] === userId) {
                        startNextRoundButton.textContent = 'SPELA IGEN (Reset)';
                        startNextRoundButton.disabled = false; // AKTIVERA KNAPPEN
                    } else {
                        startNextRoundButton.textContent = 'Väntar på skaparen att starta ny match...';
                        startNextRoundButton.disabled = true;
                    }
                }
            }

            /** Visar det detaljerade resultatet för omgången. */
            function displayResultDetails(gameData) {
                const targetTimeMs = gameData.targetTimeMs;
                roundResultsDisplay.innerHTML = ''; // Rensa gamla resultat
                let closestDeviation = Infinity;
                let closestPlayerIndex = -1;

                // 1. Beräkna avvikelser och hitta vinnare
                gameData.playerIds.forEach((id, index) => {
                    const clickTimeMs = gameData.clickTimes[index];
                    const devMs = clickTimeMs - targetTimeMs;
                    const absDev = Math.abs(devMs);
                    
                    if (absDev < closestDeviation) {
                        closestDeviation = absDev;
                        closestPlayerIndex = index;
                    }

                    const playerNumber = index + 1;
                    const colorClass = index === 0 ? 'border-red-400 bg-red-50' : (index === 1 ? 'border-blue-400 bg-blue-50' : 'border-gray-400 bg-gray-50');

                    const resultCard = document.createElement('div');
                    resultCard.className = `w-full sm:w-1/3 p-2 rounded-lg border-2 shadow-md ${colorClass}`;
                    
                    resultCard.innerHTML = `
                        <h4 class="font-bold text-lg text-gray-800">Spelare ${playerNumber}</h4>
                        <p class="text-sm">Tid: <strong class="float-right font-mono">${(clickTimeMs / MS_TO_S).toFixed(2)} s</strong></p>
                        <div class="h-px bg-gray-300 my-1"></div>
                        <p class="font-bold">Skillnad: <strong class="float-right font-mono text-base ${absDev < 100 ? 'text-green-600' : 'text-red-600'}">${formatDeviation(devMs, resultCard)}</strong></p>
                    `;
                    roundResultsDisplay.appendChild(resultCard);
                });

                // 2. Visa vinnarstatus
                roundWinnerStatus.textContent = `Spelare ${closestPlayerIndex + 1} var närmast denna omgång!`;
                
                resultArea.classList.remove('hidden'); 
            }

            /** Visar den totala poängtavlan. */
            function displayScoreboard(gameData) {
                totalScoreboard.innerHTML = ''; // Rensa gamla resultat
                totalScoreboard.classList.remove('hidden');
                
                let scores = gameData.playerIds.map((id, index) => ({
                    playerNum: index + 1,
                    totalError: gameData.totalErrors[index] || 0
                }));

                // Sortera efter lägst fel (bäst resultat)
                scores.sort((a, b) => a.totalError - b.totalError);
                
                let html = '<h3 class="text-lg font-bold mb-2 text-gray-700">Total Felmarginal (Lägst är Bäst)</h3>';

                scores.forEach((score, index) => {
                    const colorClass = index === 0 ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-100 border-gray-300';
                    const playerColor = score.playerNum === 1 ? 'text-red-700' : (score.playerNum === 2 ? 'text-blue-700' : 'text-gray-700');
                    
                    html += `
                        <div class="flex justify-between items-center p-2 rounded-lg border ${colorClass}">
                            <span class="font-bold ${playerColor}">Spelare ${score.playerNum}</span>
                            <span class="text-xl font-mono">${(score.totalError / MS_TO_S).toFixed(2)} s</span>
                        </div>
                    `;
                });
                totalScoreboard.innerHTML = html;
            }


            /** Visar slutresultatet. */
            function displayFinalWinner(gameData) {
                const scores = gameData.playerIds.map((id, index) => ({
                    playerNum: index + 1,
                    totalError: gameData.totalErrors[index] || 0
                }));
                scores.sort((a, b) => a.totalError - b.totalToError);

                let finalWinnerText = '';
                if (scores.length > 0) {
                    if (scores.length > 1 && scores[0].totalError < scores[1].totalError) {
                        finalWinnerText = `SPELARE ${scores[0].playerNum} VANN! (${(scores[0].totalError / MS_TO_S).toFixed(2)}s fel)`;
                    } else if (scores.length > 1 && scores[0].totalError === scores[1].totalError) {
                         finalWinnerText = `OAVGJORT mellan toppspelarna! Vinnare: Spelare ${scores[0].playerNum} (${(scores[0].totalError / MS_TO_S).toFixed(2)}s fel)`;
                    } else {
                        finalWinnerText = `SPELARE ${scores[0].playerNum} VANN! (${(scores[0].totalError / MS_TO_S).toFixed(2)}s fel)`;
                    }
                } else {
                    finalWinnerText = 'Inga spelare kunde hittas i resultatet.';
                }

                finalWinnerStatus.textContent = finalWinnerText;
                finalResultArea.classList.remove('hidden');
            }

            // --- REAL-TIME DATASYNC (onSnapshot) ---

            let unsubscribe = null;

            /** Lyssnar på speluppdateringar och hanterar lokal starttid. */
            function listenToGameUpdatesAndStartTime(docId) {
                if (unsubscribe) unsubscribe();
                gameId = docId;
                // Stäng av lyssnaren för tillgängliga spel när vi är i ett spel
                if (unsubscribeAvailableGames) unsubscribeAvailableGames();

                const gameRef = getGameRef(docId);
                
                unsubscribe = gameRef.onSnapshot((docSnap) => {
                    // KORRIGERING HÄR: Använd .data() för att hämta datan
                    if (docSnap.exists) { 
                        const gameData = docSnap.data();
                        
                        // Sätt spelarens index
                        playerIndex = gameData.playerIds.indexOf(userId);
                        playerRole = playerIndex === 0 ? 'P1' : (playerIndex !== -1 ? 'P_OTHER' : null);

                        if (playerIndex === -1 && gameData.status !== 'SETUP') {
                            alert("Du är inte med i detta spel.");
                            resetLocalState();
                            return;
                        }

                        // STARTTID LOGIK: Sätt den lokala starttiden när status blir WAITING_FOR_CLICKS
                        if (gameData.status === 'WAITING_FOR_CLICKS' && sessionStorage.getItem('gameStartTime') === null) {
                            // Sätt startTime till nuvarande prestandatid för att mäta elapsed time lokalt
                            sessionStorage.setItem('gameStartTime', performance.now().toString());
                        } else if (gameData.status !== 'WAITING_FOR_CLICKS') {
                            // Rensa starttiden när rundan är slut
                            sessionStorage.removeItem('gameStartTime');
                        }

                        updateUI(gameData);

                    } else {
                        // Match borttagen
                        alert("Spelet avslutades eller existerar inte längre.");
                        resetLocalState();
                    }
                }, (error) => {
                    console.error("Snapshot error:", error);
                    alert("Fel vid anslutning till spelet.");
                    resetLocalState();
                });
            }

            // --- SPELARÅTGÄRDER ---

            /** Skapar ett nytt spel (endast P1). */
            async function createNewGame() {
                // FIX: Rensar gamla lyssnare och ID
                resetGameId(); 
                
                const newGameCode = generateGameCode();
                const gameRef = getGameRef(newGameCode);

                const initialData = {
                    gameCode: newGameCode, status: 'SETUP', 
                    round: 1, maxRounds: maxRounds,
                    playerIds: [userId], // Endast skaparen
                    clickTimes: [0],
                    totalErrors: [0], // En total felmarginal per spelare
                    targetTimeMs: 0, 
                    lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                };

                try {
                    await gameRef.set(initialData);
                    listenToGameUpdatesAndStartTime(newGameCode);
                    // Dölj listan när ett spel skapas
                    document.getElementById('available-games-area').classList.add('hidden');
                } catch (error) {
                    console.error("Fel vid skapande av spel:", error);
                    alert("Kunde inte starta spelet.");
                }
            }

            /** Ansluter till ett befintligt spel (P2 och framåt). */
            window.joinExistingGame = async function(code) { // Gör global för onclick
                // Använd koden direkt om den skickas från en klickad knapp
                let finalCode = code;
                
                // Annars, hämta från input-fältet och validera
                // OBS: Manuell inmatning borttagen i HTML, så detta körs bara från klickbar lista.
                if (!finalCode) {
                    alert("Koden saknas. Vänligen klicka på ett aktivt spel i listan.");
                    return;
                }

                const gameRef = getGameRef(finalCode);

                try {
                    await db.runTransaction(async (transaction) => {
                        const gameDoc = await transaction.get(gameRef);

                        // KORRIGERING HÄR: Använd .exists på transaktionsresultatet
                        if (!gameDoc.exists) throw "Spelet existerar inte.";
                        const data = gameDoc.data();
                        
                        // FIX: Tillåt anslutning om status är SETUP, även om det är mer än 1 spelare
                        if (data.status !== 'SETUP') throw "Spelet har redan startat rundan.";
                        if (data.playerIds.includes(userId)) throw "Du är redan ansluten till detta spel.";
                        
                        // Lägg till den nya spelaren i listorna
                        const newPlayerIds = [...data.playerIds, userId];
                        const newClickTimes = [...data.clickTimes, 0];
                        const newTotalErrors = [...data.totalErrors, 0];


                        // Uppdatera: Lägg till den nya spelaren
                        transaction.update(gameRef, {
                            playerIds: newPlayerIds,
                            clickTimes: newClickTimes,
                            totalErrors: newTotalErrors,
                            lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                    });
                    
                    // Lyssna på spelet direkt efter att anslutningen lyckades
                    listenToGameUpdatesAndStartTime(finalCode);
                    document.getElementById('available-games-area').classList.add('hidden');

                } catch (error) {
                    console.error("Fel vid anslutning till spel:", error);
                    alert(`Kunde inte ansluta: ${typeof error === 'string' ? error : error.message}`);
                }
            }

            /** Uppdaterar klick-tid i databasen när en spelare klickar. */
            async function recordClickTime(gameData, clickTimeMs) {
                const gameRef = getGameRef();
                
                // Hitta spelarens index
                const playerClickIndex = gameData.playerIds.indexOf(userId);
                if (playerClickIndex === -1) return; 

                // Om spelaren redan klickat i denna omgång
                if (gameData.clickTimes[playerClickIndex] !== 0) return;

                // Använd transaktion för att säkerställa atomiska uppdateringar
                try {
                    await db.runTransaction(async (transaction) => {
                        const currentDoc = await transaction.get(gameRef);
                        if (!currentDoc.exists) return;
                        
                        const currentData = currentDoc.data();
                        
                        // Skapa kopior av listorna för uppdatering
                        let newClickTimes = [...currentData.clickTimes];
                        let newTotalErrors = [...currentData.totalErrors];
                        
                        // Uppdatera klick-tid för den aktuella spelaren
                        newClickTimes[playerClickIndex] = clickTimeMs;

                        // Kontrollera om alla spelare har klickat
                        const allClicked = newClickTimes.every(time => time !== 0);

                        let update = { clickTimes: newClickTimes };
                        
                        if (allClicked) {
                            // Beräkna resultat och uppdatera totala fel
                            const targetTimeMs = currentData.targetTimeMs;

                            currentData.playerIds.forEach((id, index) => {
                                const clickTime = newClickTimes[index]; // Använd den nya klicktiden
                                const dev = clickTime - targetTimeMs; 
                                const absDev = Math.abs(dev);
                                
                                // FIX: Uppdatera totalErrors baserat på den nya omgångens resultat
                                newTotalErrors[index] = (currentData.totalErrors[index] || 0) + absDev;
                            });
                            
                            update.totalErrors = newTotalErrors;
                            
                            // Kontrollera om matchen är slut
                            if (currentData.round < maxRounds) {
                                update.status = 'ROUND_FINISHED';
                            } else {
                                update.status = 'MATCH_FINISHED';
                            }
                        }

                        update.lastUpdateTime = firebase.firestore.FieldValue.serverTimestamp();
                        transaction.update(gameRef, update);

                    });
                } catch (error) {
                    console.error("Fel vid transaktion/inspelning av klick:", error);
                }
            }

            /** Startar nästa runda/match (endast P1). */
            async function startNextRoundOrMatch(gameData) {
                if (gameData.playerIds[0] !== userId) return; // Endast skaparen får starta
                
                const gameRef = getGameRef();
                let update = {};

                if (gameData.status === 'MATCH_FINISHED') {
                    // Återställ hela matchen
                    update = {
                        status: 'SETUP', // Återgå till SETUP för att tillåta nya spelare
                        round: 1,
                        // Återställ clickTimes och nollställ totalErrors, behåll playerIds
                        clickTimes: gameData.playerIds.map(() => 0),
                        totalErrors: gameData.playerIds.map(() => 0),
                        targetTimeMs: 0, // Sätt till 0 i SETUP-läge
                        lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                    // FIX: Efter match slut, vill vi att skaparen ska kunna ta bort gamla spelare, men för enkelhetens skull, behåller vi dem.
                } else if (gameData.status === 'ROUND_FINISHED' || gameData.status === 'SETUP') { 
                    // FIX: Tillåt start från SETUP och ROUND_FINISHED
                    // Starta nästa runda (eller omgång 1)
                    const isSetup = gameData.status === 'SETUP';
                    const nextRound = isSetup ? 1 : gameData.round + 1;

                    update = {
                        status: 'WAITING_FOR_CLICKS',
                        round: nextRound,
                        // Återställ clickTimes, behåll totalErrors
                        clickTimes: gameData.playerIds.map(() => 0),
                        targetTimeMs: generateRandomTime(),
                        lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                    };
                }

                try {
                    await gameRef.update(update);
                } catch (error) {
                    console.error("Fel vid start av nästa runda/match:", error);
                }
            }

            /** Nollställer endast gameId lokalt. Används vid start av nytt spel/omgång. */
            function resetGameId() {
                if (unsubscribe) unsubscribe();
                gameId = null;
                playerRole = null;
                playerIndex = -1;
                // Återaktivera lyssnaren för tillgängliga spel i setup-läge
                listenForAvailableGames(); 
                document.getElementById('available-games-area').classList.remove('hidden');

            }

            /** Återställer applikationen till initialt läge. */
            function resetLocalState() {
                if (unsubscribeAvailableGames) unsubscribeAvailableGames();
                resetGameId();
                sessionStorage.removeItem('gameStartTime');
                mainGameArea.classList.add('hidden');
                gameControlArea.classList.remove('hidden');
                document.getElementById('app-title').classList.remove('hidden');
                document.getElementById('app-description').classList.remove('hidden');
                // Återställ UI till grundläge
                totalScoreboard.innerHTML = '<p class="text-xs text-gray-400">Resultat visas när matchen är slut.</p>';
                availableGamesList.innerHTML = '<p class="text-xs text-gray-400">Hämtar...</p>';
                startSetupButton.disabled = false;
                
                // Anropa init för att starta om processen och hämta tillgängliga spel
                initApp(); 
            }

            // --- EVENT LISTENERS ---

            document.addEventListener('DOMContentLoaded', function() {
                try {
                    
                    // Lyssna på knappen i SETUP-läge (Starta Nytt Spel)
                    startSetupButton.addEventListener('click', async () => {
                        if (!gameId) { 
                            // 1. STARTA NYTT SPEL
                            await createNewGame();
                        } else {
                            alert("Ett spel är redan startat. Vänligen lämna matchen först.");
                        }
                    });

                    // Lyssna på knappen i GAME-läge (Starta Nästa Omgång)
                    startNextRoundButton.addEventListener('click', async () => {
                        // FIX: Hämta alltid senaste datan synkront för att undvika timingfel
                        let gameData = null;
                        
                        if (!gameId) return; // Gör inget om inget spel är aktivt

                        const gameDoc = await getGameRef().get();
                        if (gameDoc.exists) {
                            gameData = gameDoc.data();
                        }

                        if (gameData && gameData.playerIds[0] === userId && (gameData.status === 'ROUND_FINISHED' || gameData.status === 'MATCH_FINISHED' || gameData.status === 'SETUP')) {
                            // STARTA NÄSTA OMGÅNG / ÅTERSTÄLL MATCH
                            await startNextRoundOrMatch(gameData);
                        }
                        // Annars: knappen är inaktiverad eller rollen är fel, gör inget.
                    });

                    // BORTTAGEN: joinButton listener togs bort då knappen togs bort från HTML

                    multiWaitButton.addEventListener('click', async () => {
                        if (playerIndex === -1) return;

                        const gameDoc = await getGameRef().get();
                        if (!gameDoc.exists) return;

                        const gameData = gameDoc.data();
                        
                        if (gameData.status !== 'WAITING_FOR_CLICKS') return;

                        const localStartTime = parseFloat(sessionStorage.getItem('gameStartTime') || 0);
                        if (localStartTime === 0) {
                            alert("Fel: Lokal starttid saknas. Prova att starta om omgången.");
                            return;
                        }
                        
                        const finalElapsedTime = performance.now() - localStartTime;

                        // Uppdatera endast den klickade knappens text visuellt tills databasen svarar
                        multiWaitButton.textContent = 'Klickat...';
                        multiWaitButton.disabled = true;

                        await recordClickTime(gameData, finalElapsedTime);
                    });
                    
                    document.querySelector('button[onclick="resetLocalState()"]').addEventListener('click', resetLocalState);

                } catch (e) {
                    console.error("Initialization failed in main script block:", e);
                    authStatus.textContent = `KRITISKT FEL VID START: ${e.message || 'Okänt fel vid exekvering.'}`;
                }

            });
            
            // Den globala onload-funktionen som garanterar att allt är laddat
            window.onload = function() {
                initApp();
            };

        </script>
    </body>
    </html>
