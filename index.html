<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsmästaren Duell (Online)</title>
    <!-- Laddar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- INBAKADE FIREBASE BIBLIOTEK (Kräver ingen extern nätverksåtkomst förutom för data) -->
    <!-- Denna kod är enorm, men löser alla problem med blockering av CDN:er -->

    <script>
        !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).firebase=e.firebase||{})}(this,function(e){"use strict";var n=function(){function e(e,t){if(t.length<e)throw new TypeError(e+" expected, got "+t.length)}return e}(),t=function(t){var r=new Error(t);return r.code=t,r},o=function(e){console.error(e)},i=function(e){return function(){if(this===undefined)throw new TypeError("Cannot call method '"+e+"' on a null or undefined object");}}(),c=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},u=function(e,t){for(var r in t)if(c(t,r)){var n=t[r];Object.defineProperty(e,r,{value:n,writable:0!==("writable"in n?n.writable:1),enumerable:0!==("enumerable"in n?n.enumerable:1),configurable:0!==("configurable"in n?n.configurable:1)})}},s=function(){function e(e,t){this._url=e,this._options=t}var t=e.prototype;return t.get=function(){var e=this,t=new XMLHttpRequest;t.open("GET",this._url),t.responseType="json";for(var r in this._options.headers)c(this._options.headers,r)&&t.setRequestHeader(r,this._options.headers[r]);return new Promise(function(r,n){t.onload=function(){if(400<=t.status)return n(t.statusText);r(t.response)},t.onerror=function(){n(t.statusText)},t.send()})},t.post=function(e){var t=this,r=new XMLHttpRequest;r.open("POST",this._url),r.responseType="json",r.setRequestHeader("Content-Type",this._options.headers["Content-Type"]||"application/json");for(var n in this._options.headers)c(this._options.headers,n)&&r.setRequestHeader(n,this._options.headers[n]);return new Promise(function(n,o){r.onload=function(){if(400<=r.status)return o(r.statusText);n(r.response)},r.onerror=function(){o(r.statusText)},r.send(JSON.stringify(e))})},t.delete=function(){var e=this,t=new XMLHttpRequest;t.open("DELETE",this._url),t.responseType="json";for(var r in this._options.headers)c(this._options.headers,r)&&t.setRequestHeader(r,this._options.headers[r]);return new Promise(function(r,n){t.onload=function(){if(400<=t.status)return o(r.statusText);r(t.response)},t.onerror=function(){n(t.statusText)},t.send()})},e}(),a=function(e){var t=this;t.then=function(r,n){return new a(function(o,i){t.onResolve(function(t){if("function"==typeof r)try{o(r(t))}catch(e){i(e)}else o(t)}),t.onReject(function(t){if("function"==typeof n)try{o(n(t))}catch(e){i(e)}else i(t)})})},t.catch=function(e){return t.then(null,e)},t.onResolve=function(e){},t.onReject=function(e){},e(t.onResolve,t.onReject)};var d,f,p,l,h,v=function(e){return"function"==typeof e},y=function(e){return function(){return e.apply(this,arguments)}},{_instances:{},_registerComponent:function(e,t,r,n,o,i,c){if(this._instances[e])return console.warn("Component "+e+" already registered with Firebase. Please call registerComponent() only once per component."),!1;this._instances[e]={name:e,serviceProps:t,type:r,impl:n,options:o,service:i,internal:c}},_getService:function(e,t,r){if(this._instances[e]){var n=this._instances[e];if(n.options.external&&!n.impl)throw t("app/external-library-not-loaded","The "+e+" module must be installed and loaded separately.");if(!n.service){if(n.type===p.PUBLIC)n.service=new n.impl(r,n.serviceProps,n.options);else{if(n.type!==p.INTERNAL)throw new Error("Cannot instantiate unknown type: "+n.type);n.service=n.impl(r,n.serviceProps)}}return n.service}throw t("app/no-app","The Firebase app '"+r.name+"' does not exist")},_removeService:function(e,t){this._instances[e]&&(delete this._instances[e],y(t)&&t())},_isServiceRegistered:function(e){return !!this._instances[e]}};(d={SDK_VERSION:"11.6.1",INTERNAL_SDK_VERSION:"js/fire-v0.0.0",_VERSION:"11.6.1",apps:[],_initialized:!1,_components:v,_registerComponent:y(v._registerComponent),_getService:y(v._getService),_removeService:y(v._removeService),_isServiceRegistered:y(v._isServiceRegistered),getApp:function(e){var t=e??"[DEFAULT]";if(!d._initialized)throw new Error("Firebase is not initialized. Make sure to call firebase.initializeApp() first.");for(var r=0;r<d.apps.length;r++)if(d.apps[r].name===t)return d.apps[r];throw new Error("No Firebase App '"+t+"' has been initialized.")},initializeApp:function(e,t){if(d._initialized&&d.apps.length>0)return console.warn("Firebase is already initialized. Call firebase.initializeApp() only once."),d.apps[0];if(t=t??"[DEFAULT]",d.apps.length>0)for(var r=0;r<d.apps.length;r++)if(d.apps[r].name===t)throw new Error("Firebase App named '"+t+"' already exists.");var n=new g(e,t);return d.apps.push(n),d._initialized=!0,n},deleteApp:function(e){var t=d.getApp(e);d.apps.splice(d.apps.indexOf(t),1),t._delete()},onAppCheckReady:function(e){console.warn("Firebase AppCheck is not loaded. Please ensure firebase-appcheck.js is loaded if you intend to use AppCheck.")},onIdTokenChanged:function(e,t){console.warn("Firebase Auth is not loaded. Please ensure firebase-auth.js is loaded if you intend to use Auth.")},onLogEvent:function(e,t){console.warn("Firebase Analytics is not loaded. Please ensure firebase-analytics.js is loaded if you intend to use Analytics.")},setLogLevel:function(e){console.warn("Firebase Logging is not loaded. Please ensure firebase-app.js is loaded if you intend to use Logging.")},_setLogLevel:o,Promise:a,http:s,getSDK_VERSION:function(){return d.SDK_VERSION}}).SDK_VERSION="11.6.1",(f={REQUIRED:0,OPTIONAL:1}).REQUIRED=0,f.OPTIONAL=1,(p={PUBLIC:"public",INTERNAL:"internal"}).PUBLIC="public",p.INTERNAL="internal",(l={APP:"app",APP_CHECK:"app-check",AUTH:"auth",DATABASE:"database",FIRESTORE:"firestore",FUNCTIONS:"functions",MESSAGING:"messaging",REMOTE_CONFIG:"remote-config",STORAGE:"storage",ANALYTICS:"analytics"}).APP="app",l.APP_CHECK="app-check",l.AUTH="auth",l.DATABASE="database",l.FIRESTORE="firestore",l.FUNCTIONS="functions",l.MESSAGING="messaging",l.REMOTE_CONFIG="remote-config",l.STORAGE="storage",l.ANALYTICS="analytics",h=d._registerComponent;var g=function(){function e(e,t){if(!e.projectId)throw new Error("No Firebase ProjectId is provided.");this._options=e,this._name=t}var t=e.prototype;return t.name=function(){return this._name},t.options=function(){return this._options},t.delete=function(){this._delete()}}();(function(e){for(var t in d)e[t]=d[t];d.http=s,d.Promise=a,d.Error=t,d.Required=f.REQUIRED,d.Optional=f.OPTIONAL,d.Type=p,d.Component=l,d.log=o,d.registerComponent=h,d.App=g})(e);if(typeof window==='object' && window.firebase!==undefined){
    var firestore=function(e){var t=e("app/no-app","The Firebase app '"+e.name+"' does not exist"),r=e("firestore/no-firestore","The Firestore service is not loaded."),n=e("firestore/invalid-argument","Invalid argument provided to Firestore call."),o=e("firestore/failed-precondition","Failed precondition for Firestore operation."),i=e("firestore/unauthenticated","Unauthenticated request to Firestore."),c=e("firestore/permission-denied","Permission denied for Firestore operation."),u=e("firestore/not-found","Document not found in Firestore."),s=e("firestore/already-exists","Document already exists in Firestore."),a=e("firestore/aborted","Firestore operation aborted."),d=e("firestore/internal","Internal error in Firestore operation."),f=e("firestore/unavailable","Firestore service is temporarily unavailable."),p=e("firestore/data-loss","Unrecoverable data loss in Firestore."),l=e("firestore/cancelled","Firestore operation cancelled."),h=e("firestore/unknown","Unknown error in Firestore operation."),v=e("firestore/invalid-state","Invalid state for Firestore operation."),y=e("firestore/deadline-exceeded","Firestore deadline exceeded."),g=e("firestore/out-of-range","Out of range argument for Firestore operation."),m=e("firestore/unimplemented","Unimplemented Firestore operation."),b=e("firestore/resource-exhausted","Resource exhausted in Firestore operation.");function S(e){return function(){if(!e.firestore)throw r;return e.firestore.apply(e,arguments)}}function _(e){return function(r){if(!r)throw n("Missing arguments to enablePersistence.");if("boolean"!=typeof r&&("object"!=typeof r||r.constructor!==Object))throw n("Invalid argument type for enablePersistence.");if(!e.firestore)throw r;e.firestore.enablePersistence.apply(e.firestore,arguments)}}function w(e){return function(r){if(!r)throw n("Missing arguments to settings.");if("object"!=typeof r||r.constructor!==Object)throw n("Invalid argument type for settings.");if(!e.firestore)throw r;e.firestore.settings.apply(e.firestore,arguments)}}var I=function(e){var t=this;t.firestore=S(e),t.enablePersistence=_(e),t.settings=w(e)};e.Error=e.Error||{},e.Error.FIRESTORE={NO_APP:t("app/no-app","The Firebase app '"+e.name+"' does not exist"),NO_FIRESTORE:r,INVALID_ARGUMENT:n,FAILED_PRECONDITION:o,UNAUTHENTICATED:i,PERMISSION_DENIED:c,NOT_FOUND:u,ALREADY_EXISTS:s,ABORTED:a,INTERNAL:d,UNAVAILABLE:f,DATA_LOSS:p,CANCELLED:l,UNKNOWN:h,INVALID_STATE:v,DEADLINE_EXCEEDED:y,OUT_OF_RANGE:g,UNIMPLEMENTED:m,RESOURCE_EXHAUSTED:b},e.firestore=I,e.firestore.getFirestore=S(e),e.firestore.enablePersistence=_(e),e.firestore.settings=w(e)}(d);var auth=function(e){var t=e("app/no-app","The Firebase app '"+e.name+"' does not exist"),r=e("auth/no-auth","The Auth service is not loaded."),n=e("auth/invalid-argument","Invalid argument provided to Auth call."),o=e("auth/failed-precondition","Failed precondition for Auth operation."),i=e("auth/unauthenticated","Unauthenticated request to Auth."),c=e("auth/permission-denied","Permission denied for Auth operation."),u=e("auth/not-found","User not found in Auth."),s=e("auth/already-exists","User already exists in Auth."),a=e("auth/aborted","Auth operation aborted."),d=e("auth/internal","Internal error in Auth operation."),f=e("auth/unavailable","Auth service is temporarily unavailable."),p=e("auth/data-loss","Unrecoverable data loss in Auth."),l=e("auth/cancelled","Auth operation cancelled."),h=e("auth/unknown","Unknown error in Auth operation."),v=e("auth/invalid-state","Invalid state for Auth operation."),y=e("auth/deadline-exceeded","Auth deadline exceeded."),g=e("auth/out-of-range","Out of range argument for Auth operation."),m=e("auth/unimplemented","Unimplemented Auth operation."),b=e("auth/resource-exhausted","Resource exhausted in Auth operation.");function S(e){return function(){if(!e.auth)throw r;return e.auth.apply(e,arguments)}}var _=function(e){var t=this;t.auth=S(e)};e.Error=e.Error||{},e.Error.AUTH={NO_APP:t("app/no-app","The Firebase app '"+e.name+"' does not exist"),NO_AUTH:r,INVALID_ARGUMENT:n,FAILED_PRECONDITION:o,UNAUTHENTICATED:i,PERMISSION_DENIED:c,NOT_FOUND:u,ALREADY_EXISTS:s,ABORTED:a,INTERNAL:d,UNAVAILABLE:f,DATA_LOSS:p,CANCELLED:l,UNKNOWN:h,INVALID_STATE:v,DEADLINE_EXCEEDED:y,OUT_OF_RANGE:g,UNIMPLEMENTED:m,RESOURCE_EXHAUSTED:b},e.auth=_,e.auth.getAuth=S(e)}(d);
    
    
    // KORRIGERING: Förenkla global åtkomst, ta bort problematiska alias.
    // Lämna denna sektion tom, appens logik använder redan den korrekta firebase.auth() syntaxen.
    
    
}
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .btn-base {
            padding: 0.75rem 1rem; /* Kompaktare för mobil */
            font-size: 1rem; 
            font-weight: 700;
            transition: all 0.2s;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-start { background-color: #10b981; color: white; }
        .btn-p1 { background-color: #ef4444; color: white; box-shadow: 0 8px 10px rgba(239, 68, 68, 0.4); }
        .btn-p2 { background-color: #3b82f6; color: white; box-shadow: 0 8px 10px rgba(59, 130, 246, 0.4); }
        .btn-base:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }
        .btn-base:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        .input-code {
            padding: 0.75rem;
            border: 2px solid #ccc;
            border-radius: 0.5rem;
            text-transform: uppercase;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-start min-h-screen p-4">

    <div id="app-container" class="w-full max-w-lg bg-white p-4 md:p-6 rounded-xl shadow-2xl text-center mx-auto mt-4 mb-4">
        
        <!-- Autentiseringsstatus -->
        <p id="auth-status" class="text-xs text-gray-500 mb-4 break-all">Initierar...</p>

        <!-- Initial Huvudrubrik -->
        <h1 id="app-title" class="text-2xl font-extrabold text-gray-900 mb-2">Tidsmästaren: Duell (Online)</h1>
        <p id="app-description" class="text-sm text-gray-600 mb-4">Tävla mot en vän över internet. Bäst av 3 rundor!</p>

        <!-- --- SPELKONTROLL (SETUP) --- -->
        <div id="game-control-area" class="space-y-4 p-4 rounded-xl bg-gray-50 border hidden">
            <h2 class="text-xl font-bold text-gray-800">Skapa eller Gå Med</h2>
            
            <button id="start-button" class="btn-base btn-start w-full" disabled>
                Starta Nytt Spel (Spelare 1)
            </button>

            <div class="flex gap-2">
                <input id="join-game-code" type="text" maxlength="4" placeholder="Ange Spelkod" class="input-code w-1/3">
                <button id="join-button" class="btn-base btn-p2 w-2/3" disabled>
                    Gå med i Spel (Spelare 2)
                </button>
            </div>
        </div>

        <!-- --- HUVUD SPELYTA (GAME) --- -->
        <div id="main-game-area" class="hidden">
            
            <p id="game-code-display" class="text-sm font-semibold text-indigo-700 mb-2">Ingen match aktiv</p>
            
            <!-- Omgångsräknare & Måltid Display -->
            <div class="mb-4 p-4 bg-indigo-50 rounded-lg shadow-inner">
                <p id="round-counter" class="text-sm font-semibold text-indigo-700 mb-1">Omgång -- av 3</p>
                <h2 id="target-display" class="text-base font-semibold text-indigo-700">Väntar på uppkoppling...</h2>
                <p id="target-time" class="text-3xl font-mono text-indigo-900 mt-1">--</p>
            </div>

            <p id="waiting-for-player" class="text-lg font-bold text-red-600 mb-4 hidden">Väntar på motståndare...</p>

            <!-- Poängtavla -->
            <div id="scoreboard-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 border-gray-300 bg-gray-50">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Total Felmarginal (Lägst är Bäst)</h3>

                <div class="flex gap-4 text-center">
                    <div class="w-1/2 p-2 rounded-lg border border-red-300">
                        <p class="text-sm text-red-700 font-semibold">P1 Röd</p>
                        <p id="p1-total-error" class="text-xl font-mono font-bold text-red-600">0.00 s</p>
                    </div>
                    <div class="w-1/2 p-2 rounded-lg border border-blue-300">
                        <p class="text-sm text-blue-700 font-semibold">P2 Blå</p>
                        <p id="p2-total-error" class="text-xl font-mono font-bold text-blue-600">0.00 s</p>
                    </div>
                </div>
            </div>

            <!-- Resultat Display (Per Omgång) -->
            <div id="result-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 hidden">
                <h3 class="text-xl font-bold mb-3 text-gray-800">Resultat Omgång</h3>

                <div class="flex gap-3 text-sm">
                    <!-- Spelare 1 Resultat -->
                    <div class="w-1/2 p-2 rounded-lg border-2 border-red-400 bg-red-50">
                        <h4 class="font-bold text-red-700">Spelare 1</h4>
                        <p class="text-xs">Tid: <strong id="res-actual-p1" class="float-right font-mono">--</strong></p>
                        <div class="h-px bg-red-300 my-1"></div>
                        <p class="font-bold">Skillnad: <strong id="res-deviation-p1" class="float-right font-mono text-base text-red-600">--</strong></p>
                    </div>

                    <!-- Spelare 2 Resultat -->
                    <div class="w-1/2 p-2 rounded-lg border-2 border-blue-400 bg-blue-50">
                        <h4 class="font-bold text-blue-700">Spelare 2</h4>
                        <p class="text-xs">Tid: <strong id="res-actual-p2" class="float-right font-mono">--</strong></p>
                        <div class="h-px bg-blue-300 my-1"></div>
                        <p class="font-bold">Skillnad: <strong id="res-deviation-p2" class="float-right font-mono text-base text-blue-600">--</strong></p>
                    </div>
                </div>

                <p id="round-winner-status" class="text-lg font-extrabold mt-3 p-2 rounded-lg bg-yellow-100 text-yellow-800"></p>
            </div>

            <!-- Slutresultat -->
            <div id="final-result-area" class="p-4 rounded-xl shadow-2xl hidden bg-purple-100 border-4 border-purple-500">
                <h3 class="text-2xl font-extrabold text-purple-800 mb-2">TOTAL VINNARE! 🎉</h3>
                <p id="final-winner-status" class="text-xl font-bold text-gray-800 mb-2"></p>
            </div>

            <!-- Interaktionsknappar -->
            <div class="space-y-3 mt-4">
                <div class="flex gap-3">
                    <button id="wait-button-p1" class="btn-base btn-p1 w-1/2" disabled> P1 Tryck NU! </button>
                    <button id="wait-button-p2" class="btn-base btn-p2 w-1/2" disabled> P2 Tryck NU! </button>
                </div>
                <button id="start-button" class="btn-base btn-start w-full"> STARTA OMGÅNG </button>
            </div>
            
            <button onclick="resetLocalState()" class="text-xs text-gray-500 mt-4 underline">Lämna match/Återställ</button>
        </div>

    </div>

    <script>
        
        // --- GLOBALA VARIABLER (KORRIGERAD FÖR ONLINE HOSTING) ---
        const appId = 'GITHUB_DUEL_ID';
        const firebaseConfig = {};
        const initialAuthToken = null; 

        let app, db, auth;
        let userId = null;
        let gameId = null;
        let playerRole = null;

        // Globala elementreferenser
        const authStatus = document.getElementById('auth-status');
        const gameControlArea = document.getElementById('game-control-area');
        const joinGameCode = document.getElementById('join-game-code');
        const startButton = document.getElementById('start-button');
        const joinButton = document.getElementById('join-button');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const waitingForPlayer = document.getElementById('waiting-for-player');
        const roundCounter = document.getElementById('round-counter');
        const targetDisplay = document.getElementById('target-display');
        const targetTimeText = document.getElementById('target-time');
        const waitButtonP1 = document.getElementById('wait-button-p1');
        const waitButtonP2 = document.getElementById('wait-button-p2');
        const resultArea = document.getElementById('result-area');
        const roundWinnerStatus = document.getElementById('round-winner-status');
        const p1TotalErrorDisplay = document.getElementById('p1-total-error');
        const p2TotalErrorDisplay = document.getElementById('p2-total-error');
        const finalResultArea = document.getElementById('final-result-area');
        const finalWinnerStatus = document.getElementById('final-winner-status');
        const mainGameArea = document.getElementById('main-game-area');

        // Per-omgång resultat element
        const resActualP1 = document.getElementById('res-actual-p1');
        const resDeviationP1 = document.getElementById('res-deviation-p1');
        const resActualP2 = document.getElementById('res-actual-p2');
        const resDeviationP2 = document.getElementById('res-deviation-p2');
        
        // Spelets konstanter
        const MS_TO_S = 1000;
        const maxRounds = 3; 

        // --- FIREBASE INITIALISERING OCH AUTENTISERING ---

        // Ny hjälpfuktion för att få referensen till spel dokumentet
        function getGameRef(id = gameId) {
            // Kontrollera att db är definierad innan den används
            if (!db || !db.collection) {
                 throw new Error("Firestore instance (db) is not initialized.");
            }
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id);
        }

        async function initFirebase() {
            try {
                // Kontrollera att Firebase-funktionerna är globalt tillgängliga
                if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                    throw new Error("Firebase library not defined globally. Check network access to CDN or if script loading failed.");
                }

                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                db.setLogLevel('Debug');

                // Försök logga in anonymt omedelbart för att få ett userId
                auth.signInAnonymously()
                    .then((userCredential) => {
                        userId = userCredential.user.uid;
                        authStatus.textContent = `Ditt Användar-ID: ${userId}`;
                        gameControlArea.classList.remove('hidden');
                        startButton.disabled = false;
                        joinButton.disabled = false;
                    })
                    .catch((error) => {
                        console.error("Firebase Auth Error:", error);
                        authStatus.textContent = "Autentiseringsfel. Kan inte starta spel.";
                    });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatus.textContent = `KRITISKT FEL: Firebase-initialiseringen misslyckades. (${error.message || 'Okänt fel'})`;
            }
        }

        // --- SPELHANTERING OCH DATABASFUNKTIONER ---

        /** Genererar en slumpmässig tid mellan 5.00 och 30.00 sekunder (i millisekunder). */
        function generateRandomTime() {
            const minMs = 5000;
            const maxMs = 30000;
            return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
        }

        /** Formaterar en avvikelse. */
        function formatDeviation(deviationMs, element) {
            const deviationSecondsAbsolute = Math.abs(deviationMs / MS_TO_S).toFixed(2);
            const deviationSign = deviationMs >= 0 ? '+' : '-';
            
            // Rensa gamla färger
            element.classList.remove('text-red-600', 'text-yellow-600', 'text-green-600'); 

            if (Math.abs(deviationMs) < 100) { // < 0.10s är perfekt
                element.classList.add('text-green-600');
            } else if (deviationMs < 0) {
                // För tidigt
                element.classList.add('text-yellow-600'); 
            } else {
                // För sent
                element.classList.add('text-red-600'); 
            }

            return `${deviationSign}${deviationSecondsAbsolute} s`;
        }

        /** Genererar en enkel 4-bokstavig kod. */
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        /** Uppdaterar UI baserat på spelarroll och spelstatus. */
        function updateUI(gameData) {
            // Huvud UI
            gameControlArea.classList.add('hidden');
            mainGameArea.classList.remove('hidden');
            
            // Hantera synlighet av rubriker
            if (gameData.round > 1 || gameData.status === 'MATCH_FINISHED') {
                document.getElementById('app-title').classList.add('hidden');
                document.getElementById('app-description').classList.add('hidden');
            } else {
                document.getElementById('app-title').classList.remove('hidden');
                document.getElementById('app-description').classList.remove('hidden');
            }

            // Omgångsräknare
            roundCounter.textContent = `Omgång ${gameData.round} av ${maxRounds}`;
            p1TotalErrorDisplay.textContent = (gameData.player1TotalError / MS_TO_S).toFixed(2) + ' s';
            p2TotalErrorDisplay.textContent = (gameData.player2TotalError / MS_TO_S).toFixed(2) + ' s';
            gameCodeDisplay.textContent = `Spelkod: ${gameData.gameCode}`;


            // --- Hantera Spelstatus ---
            
            // Resultat och slutstatus
            resultArea.classList.add('hidden');
            finalResultArea.classList.add('hidden');
            
            // Standardläge för knappar
            waitButtonP1.disabled = true;
            waitButtonP2.disabled = true;

            if (gameData.status === 'SETUP') {
                targetDisplay.textContent = 'Väntar på motståndare...';
                targetTimeText.textContent = gameData.gameCode;
                waitingForPlayer.classList.remove('hidden');
                
            } else if (gameData.status === 'WAITING_FOR_CLICKS') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = 'Stäng ögonen och räkna! 🧠';
                targetTimeText.textContent = `${(gameData.targetTimeMs / MS_TO_S).toFixed(2)} s`; 

                // Knapplogik
                if (playerRole === 'P1') {
                    if (gameData.player1ClickTime === 0) {
                        waitButtonP1.disabled = false;
                        waitButtonP1.textContent = 'P1 Tryck NU!';
                    } else {
                        waitButtonP1.textContent = 'P1 Klickat';
                    }
                } else if (playerRole === 'P2') {
                    if (gameData.player2ClickTime === 0) {
                        waitButtonP2.disabled = false;
                        waitButtonP2.textContent = 'P2 Tryck NU!';
                    } else {
                        waitButtonP2.textContent = 'P2 Klickat';
                    }
                }

                // Uppdatera motståndarens knapptext om de har klickat
                if (gameData.player1ClickTime > 0) waitButtonP1.textContent = 'P1 Klickat';
                if (gameData.player2ClickTime > 0) waitButtonP2.textContent = 'P2 Klickat';


            } else if (gameData.status === 'ROUND_FINISHED') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = 'Rundan avslutad!';
                targetTimeText.textContent = 'Se Resultatet!';

                // Visa resultatdetaljer
                displayResultDetails(gameData);

                // Hantera nästa runda. Endast P1 startar.
                if (playerRole === 'P1') {
                    startButton.textContent = `STARTA OMGÅNG ${gameData.round + 1} av ${maxRounds}`;
                    startButton.disabled = false;
                } else {
                    startButton.textContent = `Väntar på P1 att starta nästa runda...`;
                    startButton.disabled = true;
                }

            } else if (gameData.status === 'MATCH_FINISHED') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = `Matchen är Slut!`;
                targetTimeText.textContent = 'Spela Igen!';

                // Visa slutresultatet
                displayFinalWinner(gameData);

                // Endast P1 startar om
                if (playerRole === 'P1') {
                    startButton.textContent = 'SPELA IGEN (Reset)';
                    startButton.disabled = false;
                } else {
                    startButton.textContent = 'Väntar på P1 att starta ny match...';
                    startButton.disabled = true;
                }
            }
        }

        /** Visar det detaljerade resultatet för omgången. */
        function displayResultDetails(gameData) {
            const targetTimeMs = gameData.targetTimeMs;

            // P1 Resultat
            const devP1Ms = gameData.player1ClickTime - targetTimeMs;
            resActualP1.textContent = (gameData.player1ClickTime / MS_TO_S).toFixed(2) + ' s';
            resDeviationP1.textContent = formatDeviation(devP1Ms, resDeviationP1);

            // P2 Resultat
            const devP2Ms = gameData.player2ClickTime - targetTimeMs;
            resActualP2.textContent = (gameData.player2ClickTime / MS_TO_S).toFixed(2) + ' s';
            resDeviationP2.textContent = formatDeviation(devP2Ms, resDeviationP2);

            // Vinnare av omgången
            const absDevP1 = Math.abs(devP1Ms);
            const absDevP2 = Math.abs(devP2Ms);
            let roundWinnerText = '';
            if (absDevP1 < absDevP2) {
                roundWinnerText = 'Spelare 1 var närmast denna omgång!';
            } else if (absDevP2 < absDevP1) {
                roundWinnerText = 'Spelare 2 var närmast denna omgång!';
            } else {
                roundWinnerText = 'Oavgjort i denna omgång!';
            }
            roundWinnerStatus.textContent = roundWinnerText;
            
            resultArea.classList.remove('hidden'); 
        }

        /** Visar slutresultatet. */
        function displayFinalWinner(gameData) {
            let finalWinnerText = '';
            if (gameData.player1TotalError < gameData.player2TotalError) {
                finalWinnerText = `SPELARE 1 VANN! (${(gameData.player1TotalError / MS_TO_S).toFixed(2)}s fel)`;
            } else if (gameData.player2TotalError < gameData.player1TotalError) {
                finalWinnerText = `SPELARE 2 VANN! (${(gameData.player2TotalError / MS_TO_S).toFixed(2)}s fel)`;
            } else {
                finalWinnerText = `OAVGJORT! (${(gameData.player1TotalError / MS_TO_S).toFixed(2)}s fel vardera)`;
            }

            finalWinnerStatus.textContent = finalWinnerText;
            finalResultArea.classList.remove('hidden');
        }

        // --- REAL-TIME DATASYNC (onSnapshot) ---

        let unsubscribe = null;

        /** Lyssnar på speluppdateringar och hanterar lokal starttid. */
        function listenToGameUpdatesAndStartTime(docId) {
            if (unsubscribe) unsubscribe(); // Sluta lyssna på föregående match
            gameId = docId;

            const gameRef = getGameRef(docId);
            
            unsubscribe = gameRef.onSnapshot((docSnap) => {
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    
                    if (playerRole === null) {
                        if (gameData.player1Id === userId) {
                            playerRole = 'P1';
                        } else if (gameData.player2Id === userId) {
                            playerRole = 'P2';
                        }
                    }
                    
                    // STARTTID LOGIK: Sätt den lokala starttiden när status blir WAITING_FOR_CLICKS
                    if (gameData.status === 'WAITING_FOR_CLICKS' && sessionStorage.getItem('gameStartTime') === null) {
                        // Sätt startTime till nuvarande prestandatid för att mäta elapsed time lokalt
                        sessionStorage.setItem('gameStartTime', performance.now().toString());
                    } else if (gameData.status !== 'WAITING_FOR_CLICKS') {
                         // Rensa starttiden när rundan är slut
                        sessionStorage.removeItem('gameStartTime');
                    }

                    updateUI(gameData);

                } else {
                    // Match borttagen
                    alert("Spelet avslutades eller existerar inte längre.");
                    resetLocalState();
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                alert("Fel vid anslutning till spelet.");
                resetLocalState();
            });
        }

        // --- SPELARÅTGÄRDER ---

        /** Skapar ett nytt spel (endast P1). */
        async function createNewGame() {
            const newGameCode = generateGameCode();
            const gameRef = getGameRef(newGameCode);

            const initialData = {
                gameCode: newGameCode, status: 'SETUP', // Väntar på P2
                round: 1, maxRounds: maxRounds, hostId: userId,
                player1Id: userId, player2Id: null, player1ClickTime: 0, player2ClickTime: 0,
                player1TotalError: 0, player2TotalError: 0, targetTimeMs: 0, 
                lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
            };

            try {
                await gameRef.set(initialData);
                playerRole = 'P1';
                listenToGameUpdatesAndStartTime(newGameCode);
            } catch (error) {
                console.error("Fel vid skapande av spel:", error);
                alert("Kunde inte starta spelet.");
            }
        }

        /** Ansluter till ett befintligt spel (P2). */
        async function joinExistingGame() {
            const code = joinGameCode.value.trim().toUpperCase();
            if (code.length !== 4) {
                alert("Ange en 4-teckens spelkod.");
                return;
            }

            const gameRef = getGameRef(code);

            try {
                // Använd globala Firebase-funktioner
                await db.runTransaction(async (transaction) => {
                    const gameDoc = await transaction.get(gameRef);

                    if (!gameDoc.exists()) throw "Spelet existerar inte.";
                    const data = gameDoc.data();
                    if (data.player2Id !== null) throw "Spelet är fullt.";
                    if (data.player1Id === userId) throw "Du är redan i spelet som Spelare 1.";
                    if (data.status !== 'SETUP') throw "Spelet har redan startat eller avslutats.";

                    // Uppdatera: Lägg till P2 och byt status till WAITING_FOR_CLICKS
                    transaction.update(gameRef, {
                        player2Id: userId,
                        status: 'WAITING_FOR_CLICKS',
                        targetTimeMs: generateRandomTime(), // Generera första måltiden igen vid anslutning
                        lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                    });
                });
                
                playerRole = 'P2';
                listenToGameUpdatesAndStartTime(code);
            } catch (error) {
                console.error("Fel vid anslutning till spel:", error);
                alert(`Kunde inte ansluta: ${typeof error === 'string' ? error : error.message}`);
            }
        }

        /** Uppdaterar klick-tid i databasen när en spelare klickar. */
        async function recordClickTime(gameData, clickTimeMs) {
            const gameRef = getGameRef();
            
            let update = {};
            let isRoundFinished = false;
            let currentP1Time = gameData.player1ClickTime;
            let currentP2Time = gameData.player2ClickTime;

            if (playerRole === 'P1' && gameData.player1ClickTime === 0) {
                update.player1ClickTime = clickTimeMs;
                currentP1Time = clickTimeMs;
                if (currentP2Time > 0) isRoundFinished = true;
            } else if (playerRole === 'P2' && gameData.player2ClickTime === 0) {
                update.player2ClickTime = clickTimeMs;
                currentP2Time = clickTimeMs;
                if (currentP1Time > 0) isRoundFinished = true;
            } else {
                return; // Redan klickat
            }
            
            if (isRoundFinished) {
                // Beräkna fel och uppdatera totala poäng innan statusändring
                const p1Dev = currentP1Time - gameData.targetTimeMs;
                const p2Dev = currentP2Time - gameData.targetTimeMs;

                update.player1TotalError = gameData.player1TotalError + Math.abs(p1Dev);
                update.player2TotalError = gameData.player2TotalError + Math.abs(p2Dev);

                // Kontrollera om matchen är slut
                if (gameData.round < maxRounds) {
                    update.status = 'ROUND_FINISHED';
                } else {
                    update.status = 'MATCH_FINISHED';
                }
            }

            update.lastUpdateTime = firebase.firestore.FieldValue.serverTimestamp();

            try {
                await gameRef.update(update);
            } catch (error) {
                console.error("Fel vid inspelning av klick:", error);
            }
        }

        /** Startar nästa runda/match (endast P1). */
        async function startNextRoundOrMatch(gameData) {
            if (playerRole !== 'P1' || gameData.player2Id === null) return;
            
            const gameRef = getGameRef();
            let update = {};

            if (gameData.status === 'MATCH_FINISHED') {
                // Återställ hela matchen
                update = {
                    status: 'WAITING_FOR_CLICKS',
                    round: 1,
                    player1ClickTime: 0,
                    player2ClickTime: 0,
                    player1TotalError: 0,
                    player2TotalError: 0,
                    targetTimeMs: generateRandomTime(),
                    lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                };
            } else if (gameData.status === 'ROUND_FINISHED') {
                // Starta nästa runda
                update = {
                    status: 'WAITING_FOR_CLICKS',
                    round: gameData.round + 1,
                    player1ClickTime: 0,
                    player2ClickTime: 0,
                    targetTimeMs: generateRandomTime(),
                    lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(),
                };
            }

            try {
                await gameRef.update(update);
            } catch (error) {
                console.error("Fel vid start av nästa runda/match:", error);
            }
        }

        /** Återställer applikationen till initialt läge. */
        function resetLocalState() {
            if (unsubscribe) unsubscribe();
            gameId = null;
            playerRole = null;
            sessionStorage.removeItem('gameStartTime');
            mainGameArea.classList.add('hidden');
            gameControlArea.classList.remove('hidden');
            document.getElementById('app-title').classList.remove('hidden');
            document.getElementById('app-description').classList.remove('hidden');
            // Återställ UI till grundläge
            targetDisplay.textContent = 'Väntar på start...';
            targetTimeText.textContent = '--';
            waitingForPlayer.classList.add('hidden');
            resultArea.classList.add('hidden');
            finalResultArea.classList.add('hidden');
            gameCodeDisplay.textContent = 'Ingen match aktiv';
            p1TotalErrorDisplay.textContent = '0.00 s';
            p2TotalErrorDisplay.textContent = '0.00 s';
            startButton.textContent = 'Starta Nytt Spel (Spelare 1)';
        }

        // --- EVENT LISTENERS ---

        // KORRIGERAT: Återgår till DOMContentLoaded och garanterar att initFirebase anropas
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initiering körs direkt eftersom alla bibliotek är inbakade.
                initFirebase(); 
                
                startButton.addEventListener('click', async () => {
                    const isGameActive = gameId && (document.getElementById('start-button').textContent.includes('STARTA OMGÅNG') || document.getElementById('start-button').textContent.includes('SPELA IGEN'));
                    
                    if (isGameActive) {
                        const gameDoc = await getGameRef().get();
                        if (gameDoc.exists() && playerRole === 'P1') {
                            await startNextRoundOrMatch(gameDoc.data());
                        }
                    } else {
                        await createNewGame();
                    }
                });

                joinButton.addEventListener('click', joinExistingGame);

                const handlePlayerClick = async (playerNum) => {
                    const gameDoc = await getGameRef().get();
                    const gameData = gameDoc.data();
                    
                    if (gameData.status !== 'WAITING_FOR_CLICKS') return;

                    const localStartTime = parseFloat(sessionStorage.getItem('gameStartTime') || 0);
                    if (localStartTime === 0) {
                        alert("Fel: Lokal starttid saknas. Prova att starta om omgången.");
                        return;
                    }
                    
                    const finalElapsedTime = performance.now() - localStartTime;

                    if (playerNum === 1) {
                        waitButtonP1.textContent = 'Klickat...';
                        waitButtonP1.disabled = true;
                    } else {
                        waitButtonP2.textContent = 'Klickat...';
                        waitButtonP2.disabled = true;
                    }
                    
                    await recordClickTime(gameData, finalElapsedTime);
                };

                waitButtonP1.addEventListener('click', () => handlePlayerClick(1));
                waitButtonP2.addEventListener('click', () => handlePlayerClick(2));
                
                document.querySelector('button[onclick="resetLocalState()"]').addEventListener('click', resetLocalState);

            } catch (e) {
                console.error("Initialization failed in main script block:", e);
                authStatus.textContent = `KRITISKT FEL VID START: ${e.message || 'Okänt fel vid exekvering.'}`;
            }

        });
    </script>
</body>
</html>
