<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tidsmästaren Duell (Online)</title>
    <!-- Laddar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Laddar Firebase Globalt (KORRIGERING: Använder ej "import" för att undvika blockering) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        .btn-base {
            padding: 0.75rem 1rem; /* Kompaktare för mobil */
            font-size: 1rem; 
            font-weight: 700;
            transition: all 0.2s;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-start { background-color: #10b981; color: white; }
        .btn-p1 { background-color: #ef4444; color: white; box-shadow: 0 8px 10px rgba(239, 68, 68, 0.4); }
        .btn-p2 { background-color: #3b82f6; color: white; box-shadow: 0 8px 10px rgba(59, 130, 246, 0.4); }
        .btn-base:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); }
        .btn-base:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
        .input-code {
            padding: 0.75rem;
            border: 2px solid #ccc;
            border-radius: 0.5rem;
            text-transform: uppercase;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
        }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-start min-h-screen p-4">

    <div id="app-container" class="w-full max-w-lg bg-white p-4 md:p-6 rounded-xl shadow-2xl text-center mx-auto mt-4 mb-4">
        
        <!-- Autentiseringsstatus -->
        <p id="auth-status" class="text-xs text-gray-500 mb-4 break-all">Initierar...</p>

        <!-- Initial Huvudrubrik -->
        <h1 id="app-title" class="text-2xl font-extrabold text-gray-900 mb-2">Tidsmästaren: Duell (Online)</h1>
        <p id="app-description" class="text-sm text-gray-600 mb-4">Tävla mot en vän över internet. Bäst av 3 rundor!</p>

        <!-- --- SPELKONTROLL (SETUP) --- -->
        <div id="game-control-area" class="space-y-4 p-4 rounded-xl bg-gray-50 border hidden">
            <h2 class="text-xl font-bold text-gray-800">Skapa eller Gå Med</h2>
            
            <button id="start-button" class="btn-base btn-start w-full" disabled>
                Starta Nytt Spel (Spelare 1)
            </button>

            <div class="flex gap-2">
                <input id="join-game-code" type="text" maxlength="4" placeholder="Ange Spelkod" class="input-code w-1/3">
                <button id="join-button" class="btn-base btn-p2 w-2/3" disabled>
                    Gå med i Spel (Spelare 2)
                </button>
            </div>
        </div>

        <!-- --- HUVUD SPELYTA (GAME) --- -->
        <div id="main-game-area" class="hidden">
            
            <p id="game-code-display" class="text-sm font-semibold text-indigo-700 mb-2">Ingen match aktiv</p>
            
            <!-- Omgångsräknare & Måltid Display -->
            <div class="mb-4 p-4 bg-indigo-50 rounded-lg shadow-inner">
                <p id="round-counter" class="text-sm font-semibold text-indigo-700 mb-1">Omgång -- av 3</p>
                <h2 id="target-display" class="text-base font-semibold text-indigo-700">Väntar på uppkoppling...</h2>
                <p id="target-time" class="text-3xl font-mono text-indigo-900 mt-1">--</p>
            </div>

            <p id="waiting-for-player" class="text-lg font-bold text-red-600 mb-4 hidden">Väntar på motståndare...</p>

            <!-- Poängtavla -->
            <div id="scoreboard-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 border-gray-300 bg-gray-50">
                <h3 class="text-lg font-bold mb-2 text-gray-700">Total Felmarginal (Lägst är Bäst)</h3>

                <div class="flex gap-4 text-center">
                    <div class="w-1/2 p-2 rounded-lg border border-red-300">
                        <p class="text-sm text-red-700 font-semibold">P1 Röd</p>
                        <p id="p1-total-error" class="text-xl font-mono font-bold text-red-600">0.00 s</p>
                    </div>
                    <div class="w-1/2 p-2 rounded-lg border border-blue-300">
                        <p class="text-sm text-blue-700 font-semibold">P2 Blå</p>
                        <p id="p2-total-error" class="text-xl font-mono font-bold text-blue-600">0.00 s</p>
                    </div>
                </div>
            </div>

            <!-- Resultat Display (Per Omgång) -->
            <div id="result-area" class="mb-4 p-3 rounded-xl shadow-lg border-2 hidden">
                <h3 class="text-xl font-bold mb-3 text-gray-800">Resultat Omgång</h3>

                <div class="flex gap-3 text-sm">
                    <!-- Spelare 1 Resultat -->
                    <div class="w-1/2 p-2 rounded-lg border-2 border-red-400 bg-red-50">
                        <h4 class="font-bold text-red-700">Spelare 1</h4>
                        <p class="text-xs">Tid: <strong id="res-actual-p1" class="float-right font-mono">--</strong></p>
                        <div class="h-px bg-red-300 my-1"></div>
                        <p class="font-bold">Skillnad: <strong id="res-deviation-p1" class="float-right font-mono text-base text-red-600">--</strong></p>
                    </div>

                    <!-- Spelare 2 Resultat -->
                    <div class="w-1/2 p-2 rounded-lg border-2 border-blue-400 bg-blue-50">
                        <h4 class="font-bold text-blue-700">Spelare 2</h4>
                        <p class="text-xs">Tid: <strong id="res-actual-p2" class="float-right font-mono">--</strong></p>
                        <div class="h-px bg-blue-300 my-1"></div>
                        <p class="font-bold">Skillnad: <strong id="res-deviation-p2" class="float-right font-mono text-base text-blue-600">--</strong></p>
                    </div>
                </div>

                <p id="round-winner-status" class="text-lg font-extrabold mt-3 p-2 rounded-lg bg-yellow-100 text-yellow-800"></p>
            </div>

            <!-- Slutresultat -->
            <div id="final-result-area" class="p-4 rounded-xl shadow-2xl hidden bg-purple-100 border-4 border-purple-500">
                <h3 class="text-2xl font-extrabold text-purple-800 mb-2">TOTAL VINNARE! 🎉</h3>
                <p id="final-winner-status" class="text-xl font-bold text-gray-800 mb-2"></p>
            </div>

            <!-- Interaktionsknappar -->
            <div class="space-y-3 mt-4">
                <div class="flex gap-3">
                    <button id="wait-button-p1" class="btn-base btn-p1 w-1/2" disabled> P1 Tryck NU! </button>
                    <button id="wait-button-p2" class="btn-base btn-p2 w-1/2" disabled> P2 Tryck NU! </button>
                </div>
                <button id="start-button" class="btn-base btn-start w-full"> STARTA OMGÅNG </button>
            </div>
            
            <button onclick="resetLocalState()" class="text-xs text-gray-500 mt-4 underline">Lämna match/Återställ</button>
        </div>

    </div>

    <script>
        
        // --- GLOBALA VARIABLER (KORRIGERAD FÖR ONLINE HOSTING) ---
        // Använder generiska, säkra ID:n för att appen ska starta online.
        const appId = 'GITHUB_DUEL_ID'; // Unik ID för alla som kör denna fil
        const firebaseConfig = {}; // Tom config fungerar med Canvas inloggning
        const initialAuthToken = null; 

        let app, db, auth;
        let userId = null;
        let gameId = null; // Den aktuella matchens ID
        let playerRole = null; // 'P1' eller 'P2'

        // Globala elementreferenser
        const authStatus = document.getElementById('auth-status');
        const gameControlArea = document.getElementById('game-control-area');
        const joinGameCode = document.getElementById('join-game-code');
        const startButton = document.getElementById('start-button');
        const joinButton = document.getElementById('join-button');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const waitingForPlayer = document.getElementById('waiting-for-player');
        const roundCounter = document.getElementById('round-counter');
        const targetDisplay = document.getElementById('target-display');
        const targetTimeText = document.getElementById('target-time');
        const waitButtonP1 = document.getElementById('wait-button-p1');
        const waitButtonP2 = document.getElementById('wait-button-p2');
        const resultArea = document.getElementById('result-area');
        const roundWinnerStatus = document.getElementById('round-winner-status');
        const p1TotalErrorDisplay = document.getElementById('p1-total-error');
        const p2TotalErrorDisplay = document.getElementById('p2-total-error');
        const finalResultArea = document.getElementById('final-result-area');
        const finalWinnerStatus = document.getElementById('final-winner-status');
        const mainGameArea = document.getElementById('main-game-area');

        // Per-omgång resultat element
        const resActualP1 = document.getElementById('res-actual-p1');
        const resDeviationP1 = document.getElementById('res-deviation-p1');
        const resActualP2 = document.getElementById('res-actual-p2');
        const resDeviationP2 = document.getElementById('res-deviation-p2');
        
        // Spelets konstanter
        const MS_TO_S = 1000;
        const maxRounds = 3; 

        // --- FIREBASE INITIALISERING OCH AUTENTISERING ---

        // Ny hjälpfuktion för att få referensen till spel dokumentet
        function getGameRef(id = gameId) {
            // Använd db.collection().doc() för den mest kompatibla syntaxen
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id);
        }

        async function initFirebase() {
            // Kontrollera att Firebase-funktionerna är globalt tillgängliga
            if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                authStatus.textContent = "Fel: Kunde inte ladda Firebase-biblioteken. Kontrollera din internetanslutning.";
                return;
            }

            try {
                // Använd globala Firebase-funktioner
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth(); // KORRIGERAT: Enkel global åtkomst
                db = firebase.firestore(); // KORRIGERAT: Enkel global åtkomst

                // Sätt loggningsnivån direkt efter att db har initierats
                db.setLogLevel('Debug');

                // Försök logga in anonymt omedelbart för att få ett userId
                auth.signInAnonymously() // KORRIGERAT: Använd auth instansen
                    .then((userCredential) => {
                        userId = userCredential.user.uid;
                        authStatus.textContent = `Ditt Användar-ID: ${userId}`;
                        gameControlArea.classList.remove('hidden');
                        startButton.disabled = false;
                        joinButton.disabled = false;
                    })
                    .catch((error) => {
                        console.error("Firebase Auth Error:", error);
                        authStatus.textContent = "Autentiseringsfel. Kan inte starta spel.";
                    });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatus.textContent = "Fel vid initialisering. Kontrollera din internetanslutning eller webbläsarens konsol för detaljer.";
            }
        }

        // --- SPELHANTERING OCH DATABASFUNKTIONER ---

        /** Genererar en slumpmässig tid mellan 5.00 och 30.00 sekunder (i millisekunder). */
        function generateRandomTime() {
            const minMs = 5000;
            const maxMs = 30000;
            return Math.floor(Math.random() * (maxMs - minMs + 1)) + minMs;
        }

        /** Formaterar en avvikelse. */
        function formatDeviation(deviationMs, element) {
            const deviationSecondsAbsolute = Math.abs(deviationMs / MS_TO_S).toFixed(2);
            const deviationSign = deviationMs >= 0 ? '+' : '-';
            
            // Rensa gamla färger
            element.classList.remove('text-red-600', 'text-yellow-600', 'text-green-600'); 

            if (Math.abs(deviationMs) < 100) { // < 0.10s är perfekt
                element.classList.add('text-green-600');
            } else if (deviationMs < 0) {
                // För tidigt
                element.classList.add('text-yellow-600'); 
            } else {
                // För sent
                element.classList.add('text-red-600'); 
            }

            return `${deviationSign}${deviationSecondsAbsolute} s`;
        }

        /** Genererar en enkel 4-bokstavig kod. */
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        /** Uppdaterar UI baserat på spelarroll och spelstatus. */
        function updateUI(gameData) {
            // Huvud UI
            gameControlArea.classList.add('hidden');
            mainGameArea.classList.remove('hidden');
            
            // Hantera synlighet av rubriker
            if (gameData.round > 1 || gameData.status === 'MATCH_FINISHED') {
                document.getElementById('app-title').classList.add('hidden');
                document.getElementById('app-description').classList.add('hidden');
            } else {
                document.getElementById('app-title').classList.remove('hidden');
                document.getElementById('app-description').classList.remove('hidden');
            }

            // Omgångsräknare
            roundCounter.textContent = `Omgång ${gameData.round} av ${maxRounds}`;
            p1TotalErrorDisplay.textContent = (gameData.player1TotalError / MS_TO_S).toFixed(2) + ' s';
            p2TotalErrorDisplay.textContent = (gameData.player2TotalError / MS_TO_S).toFixed(2) + ' s';
            gameCodeDisplay.textContent = `Spelkod: ${gameData.gameCode}`;


            // --- Hantera Spelstatus ---
            
            // Resultat och slutstatus
            resultArea.classList.add('hidden');
            finalResultArea.classList.add('hidden');
            
            // Standardläge för knappar
            waitButtonP1.disabled = true;
            waitButtonP2.disabled = true;

            if (gameData.status === 'SETUP') {
                targetDisplay.textContent = 'Väntar på motståndare...';
                targetTimeText.textContent = gameData.gameCode;
                waitingForPlayer.classList.remove('hidden');
                
            } else if (gameData.status === 'WAITING_FOR_CLICKS') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = 'Stäng ögonen och räkna! 🧠';
                targetTimeText.textContent = `${(gameData.targetTimeMs / MS_TO_S).toFixed(2)} s`; 

                // Knapplogik
                if (playerRole === 'P1') {
                    if (gameData.player1ClickTime === 0) {
                        waitButtonP1.disabled = false;
                        waitButtonP1.textContent = 'P1 Tryck NU!';
                    } else {
                        waitButtonP1.textContent = 'P1 Klickat';
                    }
                } else if (playerRole === 'P2') {
                    if (gameData.player2ClickTime === 0) {
                        waitButtonP2.disabled = false;
                        waitButtonP2.textContent = 'P2 Tryck NU!';
                    } else {
                        waitButtonP2.textContent = 'P2 Klickat';
                    }
                }

                // Uppdatera motståndarens knapptext om de har klickat
                if (gameData.player1ClickTime > 0) waitButtonP1.textContent = 'P1 Klickat';
                if (gameData.player2ClickTime > 0) waitButtonP2.textContent = 'P2 Klickat';


            } else if (gameData.status === 'ROUND_FINISHED') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = 'Rundan avslutad!';
                targetTimeText.textContent = 'Se Resultatet!';

                // Visa resultatdetaljer
                displayResultDetails(gameData);

                // Hantera nästa runda. Endast P1 startar.
                if (playerRole === 'P1') {
                    startButton.textContent = `STARTA OMGÅNG ${gameData.round + 1} av ${maxRounds}`;
                    startButton.disabled = false;
                } else {
                    startButton.textContent = `Väntar på P1 att starta nästa runda...`;
                    startButton.disabled = true;
                }

            } else if (gameData.status === 'MATCH_FINISHED') {
                waitingForPlayer.classList.add('hidden');
                targetDisplay.textContent = `Matchen är Slut!`;
                targetTimeText.textContent = 'Spela Igen!';

                // Visa slutresultatet
                displayFinalWinner(gameData);

                // Endast P1 startar om
                if (playerRole === 'P1') {
                    startButton.textContent = 'SPELA IGEN (Reset)';
                    startButton.disabled = false;
                } else {
                    startButton.textContent = 'Väntar på P1 att starta ny match...';
                    startButton.disabled = true;
                }
            }
        }

        /** Visar det detaljerade resultatet för omgången. */
        function displayResultDetails(gameData) {
            const targetTimeMs = gameData.targetTimeMs;

            // P1 Resultat
            const devP1Ms = gameData.player1ClickTime - targetTimeMs;
            resActualP1.textContent = (gameData.player1ClickTime / MS_TO_S).toFixed(2) + ' s';
            resDeviationP1.textContent = formatDeviation(devP1Ms, resDeviationP1);

            // P2 Resultat
            const devP2Ms = gameData.player2ClickTime - targetTimeMs;
            resActualP2.textContent = (gameData.player2ClickTime / MS_TO_S).toFixed(2) + ' s';
            resDeviationP2.textContent = formatDeviation(devP2Ms, resDeviationP2);

            // Vinnare av omgången
            const absDevP1 = Math.abs(devP1Ms);
            const absDevP2 = Math.abs(devP2Ms);
            let roundWinnerText = '';
            if (absDevP1 < absDevP2) {
                roundWinnerText = 'Spelare 1 var närmast denna omgång!';
            } else if (absDevP2 < absDevP1) {
                roundWinnerText = 'Spelare 2 var närmast denna omgång!';
            } else {
                roundWinnerText = 'Oavgjort i denna omgång!';
            }
            roundWinnerStatus.textContent = roundWinnerText;
            
            resultArea.classList.remove('hidden'); 
        }

        /** Visar slutresultatet. */
        function displayFinalWinner(gameData) {
            let finalWinnerText = '';
            if (gameData.player1TotalError < gameData.player2TotalError) {
                finalWinnerText = `SPELARE 1 VANN! (${(gameData.player1TotalError / MS_TO_S).toFixed(2)}s fel)`;
            } else if (gameData.player2TotalError < gameData.player1TotalError) {
                finalWinnerText = `SPELARE 2 VANN! (${(gameData.player2TotalError / MS_TO_S).toFixed(2)}s fel)`;
            } else {
                finalWinnerText = `OAVGJORT! (${(gameData.player1TotalError / MS_TO_S).toFixed(2)}s fel vardera)`;
            }

            finalWinnerStatus.textContent = finalWinnerText;
            finalResultArea.classList.remove('hidden');
        }

        // --- REAL-TIME DATASYNC (onSnapshot) ---

        let unsubscribe = null;

        /** Lyssnar på speluppdateringar och hanterar lokal starttid. */
        function listenToGameUpdatesAndStartTime(docId) {
            if (unsubscribe) unsubscribe(); // Sluta lyssna på föregående match
            gameId = docId;

            const gameRef = getGameRef(docId); // KORRIGERAT
            
            unsubscribe = gameRef.onSnapshot((docSnap) => { // KORRIGERAT: Använd docRef.onSnapshot
                if (docSnap.exists()) {
                    const gameData = docSnap.data();
                    
                    if (playerRole === null) {
                        if (gameData.player1Id === userId) {
                            playerRole = 'P1';
                        } else if (gameData.player2Id === userId) {
                            playerRole = 'P2';
                        }
                    }
                    
                    // STARTTID LOGIK: Sätt den lokala starttiden när status blir WAITING_FOR_CLICKS
                    if (gameData.status === 'WAITING_FOR_CLICKS' && sessionStorage.getItem('gameStartTime') === null) {
                        // Sätt startTime till nuvarande prestandatid för att mäta elapsed time lokalt
                        sessionStorage.setItem('gameStartTime', performance.now().toString());
                    } else if (gameData.status !== 'WAITING_FOR_CLICKS') {
                         // Rensa starttiden när rundan är slut
                        sessionStorage.removeItem('gameStartTime');
                    }

                    updateUI(gameData);

                } else {
                    // Match borttagen
                    alert("Spelet avslutades eller existerar inte längre.");
                    resetLocalState();
                }
            }, (error) => {
                console.error("Snapshot error:", error);
                alert("Fel vid anslutning till spelet.");
                resetLocalState();
            });
        }

        // --- SPELARÅTGÄRDER ---

        /** Skapar ett nytt spel (endast P1). */
        async function createNewGame() {
            const newGameCode = generateGameCode();
            const gameRef = getGameRef(newGameCode); // KORRIGERAT

            const initialData = {
                gameCode: newGameCode, status: 'SETUP', // Väntar på P2
                round: 1, maxRounds: maxRounds, hostId: userId,
                player1Id: userId, player2Id: null, player1ClickTime: 0, player2ClickTime: 0,
                player1TotalError: 0, player2TotalError: 0, targetTimeMs: 0, 
                lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(), // KORRIGERAT
            };

            try {
                await gameRef.set(initialData); // KORRIGERAT: Använd docRef.set
                playerRole = 'P1';
                listenToGameUpdatesAndStartTime(newGameCode);
            } catch (error) {
                console.error("Fel vid skapande av spel:", error);
                alert("Kunde inte starta spelet.");
            }
        }

        /** Ansluter till ett befintligt spel (P2). */
        async function joinExistingGame() {
            const code = joinGameCode.value.trim().toUpperCase();
            if (code.length !== 4) {
                alert("Ange en 4-teckens spelkod.");
                return;
            }

            const gameRef = getGameRef(code); // KORRIGERAT

            try {
                // Använd globala Firebase-funktioner
                await db.runTransaction(async (transaction) => { // KORRIGERAT: Använd db.runTransaction
                    const gameDoc = await transaction.get(gameRef);

                    if (!gameDoc.exists()) throw "Spelet existerar inte.";
                    const data = gameDoc.data();
                    if (data.player2Id !== null) throw "Spelet är fullt.";
                    if (data.player1Id === userId) throw "Du är redan i spelet som Spelare 1.";
                    if (data.status !== 'SETUP') throw "Spelet har redan startat eller avslutats.";

                    // Uppdatera: Lägg till P2 och byt status till WAITING_FOR_CLICKS
                    const targetTime = generateRandomTime(); // Generera första måltiden
                    transaction.update(gameRef, {
                        player2Id: userId,
                        status: 'WAITING_FOR_CLICKS',
                        targetTimeMs: targetTime,
                        lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(), // KORRIGERAT
                    });
                });
                
                playerRole = 'P2';
                listenToGameUpdatesAndStartTime(code);
            } catch (error) {
                console.error("Fel vid anslutning till spel:", error);
                alert(`Kunde inte ansluta: ${typeof error === 'string' ? error : error.message}`);
            }
        }

        /** Uppdaterar klick-tid i databasen när en spelare klickar. */
        async function recordClickTime(gameData, clickTimeMs) {
            const gameRef = getGameRef(); // KORRIGERAT
            
            let update = {};
            let isRoundFinished = false;
            let currentP1Time = gameData.player1ClickTime;
            let currentP2Time = gameData.player2ClickTime;

            if (playerRole === 'P1' && gameData.player1ClickTime === 0) {
                update.player1ClickTime = clickTimeMs;
                currentP1Time = clickTimeMs;
                if (currentP2Time > 0) isRoundFinished = true;
            } else if (playerRole === 'P2' && gameData.player2ClickTime === 0) {
                update.player2ClickTime = clickTimeMs;
                currentP2Time = clickTimeMs;
                if (currentP1Time > 0) isRoundFinished = true;
            } else {
                return; // Redan klickat
            }
            
            if (isRoundFinished) {
                // Beräkna fel och uppdatera totala poäng innan statusändring
                const p1Dev = currentP1Time - gameData.targetTimeMs;
                const p2Dev = currentP2Time - gameData.targetTimeMs;

                update.player1TotalError = gameData.player1TotalError + Math.abs(p1Dev);
                update.player2TotalError = gameData.player2TotalError + Math.abs(p2Dev);

                // Kontrollera om matchen är slut
                if (gameData.round < maxRounds) {
                    update.status = 'ROUND_FINISHED';
                } else {
                    update.status = 'MATCH_FINISHED';
                }
            }

            update.lastUpdateTime = firebase.firestore.FieldValue.serverTimestamp(); // KORRIGERAT

            try {
                await gameRef.update(update); // KORRIGERAT: Använd docRef.update
            } catch (error) {
                console.error("Fel vid inspelning av klick:", error);
            }
        }

        /** Startar nästa runda/match (endast P1). */
        async function startNextRoundOrMatch(gameData) {
            if (playerRole !== 'P1' || gameData.player2Id === null) return;
            
            const gameRef = getGameRef(); // KORRIGERAT
            let update = {};

            if (gameData.status === 'MATCH_FINISHED') {
                // Återställ hela matchen
                update = {
                    status: 'WAITING_FOR_CLICKS',
                    round: 1,
                    player1ClickTime: 0,
                    player2ClickTime: 0,
                    player1TotalError: 0,
                    player2TotalError: 0,
                    targetTimeMs: generateRandomTime(),
                    lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(), // KORRIGERAT
                };
            } else if (gameData.status === 'ROUND_FINISHED') {
                // Starta nästa runda
                update = {
                    status: 'WAITING_FOR_CLICKS',
                    round: gameData.round + 1,
                    player1ClickTime: 0,
                    player2ClickTime: 0,
                    targetTimeMs: generateRandomTime(),
                    lastUpdateTime: firebase.firestore.FieldValue.serverTimestamp(), // KORRIGERAT
                };
            }

            try {
                await gameRef.update(update); // KORRIGERAT: Använd docRef.update
            } catch (error) {
                console.error("Fel vid start av nästa runda/match:", error);
            }
        }

        /** Återställer applikationen till initialt läge. */
        function resetLocalState() {
            if (unsubscribe) unsubscribe();
            gameId = null;
            playerRole = null;
            sessionStorage.removeItem('gameStartTime');
            mainGameArea.classList.add('hidden');
            gameControlArea.classList.remove('hidden');
            document.getElementById('app-title').classList.remove('hidden');
            document.getElementById('app-description').classList.remove('hidden');
            // Återställ UI till grundläge
            targetDisplay.textContent = 'Väntar på start...';
            targetTimeText.textContent = '--';
            waitingForPlayer.classList.add('hidden');
            resultArea.classList.add('hidden');
            finalResultArea.classList.add('hidden');
            gameCodeDisplay.textContent = 'Ingen match aktiv';
            p1TotalErrorDisplay.textContent = '0.00 s';
            p2TotalErrorDisplay.textContent = '0.00 s';
            startButton.textContent = 'Starta Nytt Spel (Spelare 1)';
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            
            startButton.addEventListener('click', async () => {
                const isGameActive = gameId && (document.getElementById('start-button').textContent.includes('STARTA OMGÅNG') || document.getElementById('start-button').textContent.includes('SPELA IGEN'));
                
                if (isGameActive) {
                    // P1 klickar på STARTA OMGÅNG / SPELA IGEN
                    const gameDoc = await getGameRef().get(); // KORRIGERAT: Använd docRef.get
                    if (gameDoc.exists() && playerRole === 'P1') {
                        await startNextRoundOrMatch(gameDoc.data());
                    }
                } else {
                    // Starta ny match (vid första klicket)
                    await createNewGame();
                }
            });

            joinButton.addEventListener('click', joinExistingGame);

            // Spelarklick-hantering
            const handlePlayerClick = async (playerNum) => {
                const gameDoc = await getGameRef().get(); // KORRIGERAT: Använd docRef.get
                const gameData = gameDoc.data();
                
                if (gameData.status !== 'WAITING_FOR_CLICKS') return;

                const localStartTime = parseFloat(sessionStorage.getItem('gameStartTime') || 0);
                if (localStartTime === 0) {
                    alert("Fel: Lokal starttid saknas. Prova att starta om omgången.");
                    return;
                }
                
                // Beräkna förfluten tid från när rundan startade lokalt
                const finalElapsedTime = performance.now() - localStartTime;

                // Uppdatera knappen (visuellt innan databasändring)
                if (playerNum === 1) {
                    waitButtonP1.textContent = 'Klickat...';
                    waitButtonP1.disabled = true;
                } else {
                    waitButtonP2.textContent = 'Klickat...';
                    waitButtonP2.disabled = true;
                }
                
                // Skicka den förflutna tiden till databasen
                await recordClickTime(gameData, finalElapsedTime);
            };

            waitButtonP1.addEventListener('click', () => handlePlayerClick(1));
            waitButtonP2.addEventListener('click', () => handlePlayerClick(2));
            
            // Länka återställningsknappen
            document.querySelector('button[onclick="resetLocalState()"]').addEventListener('click', resetLocalState);
        });

    </script>
</body>
</html>
